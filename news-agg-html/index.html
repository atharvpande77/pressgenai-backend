<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>News Dashboard</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <!-- Google Fonts for Icons -->
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0" />
        <style>
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        .btn-spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            width: 20px;
            height: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .news-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
            border: 2px solid transparent;
        }
        .news-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .news-card.selected {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .location-dropdown {
            max-height: 200px;
            overflow-y: auto;
        }
        .line-clamp-1 {
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .tab-button {
            color: #6b7280; /* text-gray-500 */
            border-bottom-width: 2px;
            border-color: transparent;
            transition-property: all;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 200ms;
        }
        .tab-button:hover {
            color: #2563eb; /* text-blue-600 */
            border-color: #bfdbfe; /* border-blue-200 */
        }
        .tab-active {
            color: #2563eb; /* text-blue-600 */
            border-color: #2563eb; /* border-blue-600 */
            background-color: #eff6ff; /* bg-blue-50 */
            font-weight: 600; /* font-semibold */
        }
        /* Style for Google Font Icons */
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        .checkbox-container {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background-color: white;
            width: 28px;
            height: 28px;
            border-radius: 9999px; /* full circle */
            display: flex; /* Always visible */
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
            pointer-events: none; /* Clicks go through to the card */
        }
        .checkbox-container .material-symbols-outlined {
            font-size: 24px;
            line-height: 1;
            color: #9ca3af; /* gray-400 for unchecked state */
        }
        .news-card.selected .checkbox-container .material-symbols-outlined {
            font-variation-settings: 'FILL' 1, 'wght' 700;
            color: #3b82f6; /* blue-500 */
        }
        /* Slide-over Panel */
        #slideOverContainer {
            transition: visibility 0.3s;
        }
        #slideOverPanel {
            transition: transform 0.3s ease-in-out;
        }
        /* Toast Notification */
        #toast {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        </style>
    </head>
    <body class="bg-gray-50 min-h-screen">
        <!-- Location Selection (Initial View) -->
        <div id="locationSelection" class="max-w-2xl mx-auto px-4 py-12">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-gray-900 mb-4">Get Local
                    News</h2>
                <p class="text-gray-600">Select your location to get
                    personalized news from your city, state, country and around
                    the world</p>
            </div>
            <div class="bg-white rounded-lg shadow-lg p-6">
                <!-- Search Bar -->
                <div class="relative mb-4">
                    <input
                        type="text"
                        id="locationSearch"
                        placeholder="Search for your city..."
                        class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                    <div class="absolute right-3 top-3">
                        <svg class="w-6 h-6 text-gray-400" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                    <div id="locationDropdown"
                        class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg hidden location-dropdown">
                    </div>
                </div>
                <div class="flex items-center my-6">
                    <hr class="flex-1 border-gray-300">
                    <span class="px-4 text-gray-500 text-sm">OR</span>
                    <hr class="flex-1 border-gray-300">
                </div>
                <button
                    id="useGeolocation"
                    class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-200 flex items-center justify-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            stroke-width="2"
                            d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round"
                            stroke-width="2"
                            d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    <span>Use My Current Location</span>
                </button>
                <div id="locationLoading" class="hidden text-center py-4">
                    <div class="spinner mx-auto mb-2"></div>
                    <p class="text-gray-600">Detecting your location...</p>
                </div>
                <div id="locationError"
                    class="hidden mt-4 p-3 bg-red-50 text-red-700 rounded-lg text-sm"></div>
            </div>
        </div>

        <!-- Main Application View (Sidebar + Content) -->
        <div id="appContainer" class="hidden">
            <div class="flex min-h-screen">
                <!-- Sidebar -->
                <aside class="w-64 bg-white shadow-md flex-shrink-0">
                    <div class="p-6">
                        <h1 class="text-2xl font-bold text-gray-900">NewsHub</h1>
                    </div>
                    <nav class="mt-6 px-4">
                        <a href="#" data-view="discover"
                            class="sidebar-link group flex items-center px-4 py-3 text-gray-700 rounded-lg bg-gray-100 font-semibold">
                            <span class="material-symbols-outlined mr-3 text-gray-500 group-hover:text-blue-600">travel_explore</span>
                            Discover
                        </a>
                        <a href="#" data-view="generate"
                            class="sidebar-link group flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 hover:font-semibold">
                            <span class="material-symbols-outlined mr-3 text-gray-500 group-hover:text-blue-600">auto_awesome</span>
                            Generate
                        </a>
                        <a href="#" data-view="articles"
                            class="sidebar-link group flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 hover:font-semibold">
                           <span class="material-symbols-outlined mr-3 text-gray-500 group-hover:text-blue-600">article</span>
                            My Articles
                        </a>
                    </nav>
                </aside>

                <!-- Main Content Area -->
                <main class="flex-1 bg-gray-50">
                    <!-- Discover View (News Dashboard) -->
                    <div id="discoverView" class="main-view">
                        <!-- Header -->
                        <header class="bg-white shadow-sm border-b sticky top-0 z-10">
                            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-4">
                                        <h2 class="text-lg font-semibold text-gray-900" id="currentLocation"></h2>
                                        <button id="changeLocation" class="text-blue-600 hover:text-blue-700 text-sm font-medium">
                                            Change Location
                                        </button>
                                    </div>
                                    <div class="text-sm text-gray-500" id="lastUpdated"></div>
                                </div>
                            </div>
                        </header>
                        
                        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                            <div class="border-b border-gray-200 mb-6">
                                <nav class="flex space-x-1 overflow-x-auto" aria-label="News categories">
                                    <button
                                        class="tab-button py-3 px-6 rounded-t-lg whitespace-nowrap"
                                        data-tab="city" aria-selected="true"
                                        role="tab">
                                        <span class="tab-label" id="cityTabLabel">City</span>
                                    </button>
                                    <button
                                        class="tab-button py-3 px-6 rounded-t-lg whitespace-nowrap"
                                        data-tab="state" aria-selected="false"
                                        role="tab">
                                        <span class="tab-label" id="stateTabLabel">State</span>
                                    </button>
                                    <button
                                        class="tab-button py-3 px-6 rounded-t-lg whitespace-nowrap"
                                        data-tab="country" aria-selected="false"
                                        role="tab">
                                        <span class="tab-label" id="countryTabLabel">Country</span>
                                    </button>
                                    <button
                                        class="tab-button py-3 px-6 rounded-t-lg whitespace-nowrap"
                                        data-tab="international"
                                        aria-selected="false" role="tab">
                                        <span class="tab-label">International</span>
                                    </button>
                                </nav>
                            </div>

                            <div id="newsLoading" class="hidden text-center py-12">
                                <div class="spinner mx-auto mb-4"></div>
                                <p class="text-gray-600 text-lg">Loading news...</p>
                            </div>
                            <div id="newsError" class="hidden p-4 bg-red-50 text-red-700 rounded-lg mb-6 text-center">
                                <p>Failed to load news. Please try again later.</p>
                                <button id="retryLoading" class="mt-2 px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors">
                                    Try Again
                                </button>
                            </div>
                            <div id="newsContent" role="tabpanel" aria-labelledby="tab-city" class="pb-24"></div>
                        </div>
                    </div>
                    
                    <!-- Generate View -->
                    <div id="generateView" class="main-view hidden">
                        <header class="bg-white shadow-sm border-b sticky top-0 z-10">
                           <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                              <h2 class="text-xl font-bold text-gray-900">Selected Articles</h2>
                               <button id="generateAllButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center space-x-2 text-sm">
                                   <span class="material-symbols-outlined">auto_awesome</span>
                                   <span>Generate All</span>
                               </button>
                           </div>
                       </header>
                        <div id="generateContent" class="p-8"></div>
                    </div>

                    <!-- My Articles View -->
                    <div id="articlesView" class="main-view hidden">
                         <header class="bg-white shadow-sm border-b sticky top-0 z-10">
                            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                               <h2 class="text-xl font-bold text-gray-900">My Articles</h2>
                            </div>
                        </header>
                        <div id="myArticlesContent" class="p-8"></div>
                    </div>
                </main>
            </div>
        </div>
        
        <!-- Sticky Selection Bar -->
        <div id="selectionBar" class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-sm border-t border-gray-200 p-4 z-20 transform translate-y-full transition-transform duration-300 ease-in-out">
             <div class="max-w-7xl mx-auto flex justify-between items-center pl-64"> <!-- pl-64 to offset for sidebar -->
                 <p id="selectionCount" class="font-medium text-gray-800"></p>
                 <button id="openGenerateTabButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition-colors flex items-center space-x-2">
                    <span>Open Generate</span>
                    <span class="material-symbols-outlined">arrow_forward</span>
                 </button>
             </div>
        </div>

        <!-- Slide-over Panel -->
        <div id="slideOverContainer" class="fixed inset-0 z-30 overflow-hidden invisible" aria-labelledby="slide-over-title" role="dialog" aria-modal="true">
            <div class="absolute inset-0 overflow-hidden">
                <div id="slideOverBackdrop" class="absolute inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
                <div class="fixed inset-y-0 right-0 pl-10 max-w-full flex">
                    <div id="slideOverPanel" class="w-screen max-w-md transform translate-x-full">
                        <!-- Panel content will be injected here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Toast Notification -->
        <div id="toast" class="fixed bottom-5 right-5 bg-gray-900 text-white py-3 px-5 rounded-lg shadow-lg transform translate-x-[150%] opacity-0 flex items-center justify-between space-x-4">
            <!-- Toast content will be injected here -->
        </div>


        <script>
    // Global state
    let currentLocationData = null;
    let currentTab = 'city';
    let newsData = {}; // Cache for loaded news data
    const selectedArticles = new Map(); // Use Map to store full article objects
    const workspaceArticles = new Map(); // Articles moved to the "Generate" tab
    let searchTimeout;

    const API_BASE_URL = 'https://www.citihubkiosk.com/pressgenai/api/stories'

    // DOM elements
    const locationSelection = document.getElementById('locationSelection');
    const appContainer = document.getElementById('appContainer');
    const locationSearch = document.getElementById('locationSearch');
    const locationDropdown = document.getElementById('locationDropdown');
    const useGeolocationBtn = document.getElementById('useGeolocation');
    const locationLoading = document.getElementById('locationLoading');
    const locationError = document.getElementById('locationError');
    const newsLoading = document.getElementById('newsLoading');
    const newsError = document.getElementById('newsError');
    const newsContent = document.getElementById('newsContent');
    const currentLocationEl = document.getElementById('currentLocation');
    const changeLocationBtn = document.getElementById('changeLocation');
    const tabButtons = document.querySelectorAll('.tab-button');
    const retryLoadingBtn = document.getElementById('retryLoading');
    const sidebarLinks = document.querySelectorAll('.sidebar-link');
    const mainViews = document.querySelectorAll('.main-view');
    const selectionBar = document.getElementById('selectionBar');
    const selectionCount = document.getElementById('selectionCount');
    const openGenerateTabButton = document.getElementById('openGenerateTabButton');
    const generateAllButton = document.getElementById('generateAllButton');
    const slideOverContainer = document.getElementById('slideOverContainer');
    const slideOverPanel = document.getElementById('slideOverPanel');
    const slideOverBackdrop = document.getElementById('slideOverBackdrop');

    // Initialize the application
    function initApp() {
        const savedLocation = localStorage.getItem('newsHubLocation');
        if (savedLocation) {
            try {
                selectLocation(JSON.parse(savedLocation));
            } catch (e) {
                localStorage.removeItem('newsHubLocation');
            }
        }
        updateActiveTab(currentTab); // Ensure initial tab state is correct
    }

    // --- LOCATION & DATA FETCHING ---
    async function searchLocations(query) {
        try {
            const response = await fetch(`https://api.geocode.earth/v1/search?text=${encodeURIComponent(query)}&size=5&api_key=ge-9999fb348a288c9d`);
            if (!response.ok) throw new Error(`API error: ${response.status}`);
            const data = await response.json();
            const results = data.features.map(f => ({
                city: f.properties.locality || f.properties.name || '', state: f.properties.region || '',
                country_name: f.properties.country || '', country: f.properties.country_code || '',
                formatted: (f.properties.label || `${f.properties.locality}, ${f.properties.region}, ${f.properties.country}`).trim().replace(/,\s*$/, '').replace(/,,/, ',')
            })).filter(item => item.city && item.country_name);
            displayLocationResults(results);
        } catch (error) {
            console.error('Error searching locations:', error);
            displayLocationResults([]);
        }
    }

    function displayLocationResults(results) {
        if (results.length === 0) {
            locationDropdown.innerHTML = `<div class="px-4 py-3 text-gray-500 text-center">No locations found.</div>`;
        } else {
            locationDropdown.innerHTML = results.map(r => `
                <div class="px-4 py-3 hover:bg-gray-50 cursor-pointer border-b last:border-b-0" 
                     tabindex="0" 
                     onclick='selectLocation(${JSON.stringify(r)})'
                     onkeydown="if(event.key === 'Enter' || event.key === ' ') { selectLocation(${JSON.stringify(r)}); event.preventDefault(); }">
                    <div class="font-medium text-gray-900">${r.city}</div>
                    <div class="text-sm text-gray-600">${r.state}, ${r.country_name}</div>
                </div>`).join('');
        }
        locationDropdown.classList.remove('hidden');
    }
    
    function showLocationError(message) {
        locationError.textContent = message;
        locationError.classList.remove('hidden');
    }

    async function selectLocation(locationData) {
        currentLocationData = locationData;
        localStorage.setItem('newsHubLocation', JSON.stringify(locationData));
        locationSelection.classList.add('hidden');
        appContainer.classList.remove('hidden');
        currentLocationEl.textContent = `${locationData.city}, ${locationData.state}`;
        updateTabLabels(locationData);
        newsData = {};
        selectedArticles.clear();
        updateSelectionBar();
        currentTab = 'city';
        updateActiveTab('city');
        await loadNewsForTab('city');
    }

    async function loadNewsForTab(tab) {
        newsLoading.classList.remove('hidden');
        newsError.classList.add('hidden');
        newsContent.innerHTML = '';
        selectedArticles.clear();
        updateSelectionBar();
        try {
            const articles = await fetchNewsFromApi(tab);
            newsData[tab] = articles;
            displayNews(articles);
            document.getElementById('lastUpdated').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
        } catch (error) {
            console.error("A critical error occurred while loading news:", error);
            newsError.classList.remove('hidden');
            displayNews([]);
        } finally {
            newsLoading.classList.add('hidden');
        }
    }

    async function fetchNewsFromApi(scope) {
        if (!currentLocationData) return [];
        const apiScope = scope.toUpperCase();
        const requestBody = {
            scope: apiScope, query: '', country_code: null, location: null
        };
        switch (apiScope) {
            case 'CITY':
                requestBody.query = currentLocationData.city.toUpperCase();
                requestBody.country_code = currentLocationData.country;
                requestBody.location = { city: currentLocationData.city.toUpperCase(), state: currentLocationData.state.toUpperCase(), country: currentLocationData.country_name.toUpperCase() };
                break;
            case 'STATE':
                requestBody.query = currentLocationData.state.toUpperCase();
                requestBody.country_code = currentLocationData.country;
                requestBody.location = { city: null, state: currentLocationData.state.toUpperCase(), country: currentLocationData.country_name.toUpperCase() };
                break;
            case 'COUNTRY':
                requestBody.query = currentLocationData.country_name.toUpperCase();
                requestBody.country_code = currentLocationData.country;
                requestBody.location = { city: null, state: null, country: currentLocationData.country_name.toUpperCase() };
                break;
            case 'INTERNATIONAL':
                requestBody.query = 'world';
                break;
        }
        try {
            const response = await fetch(`${API_BASE_URL}/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });
            if (!response.ok) throw new Error(`API returned ${response.status}`);
            const data = await response.json();
            data.stories.forEach((story, index) => { if (!story.id) story.id = `${scope}-${index}-${Math.random()}`; });
            return data.stories;
        } catch (error) {
            console.error(`Error fetching real news for ${scope}, falling back to mock data:`, error);
            return generateMockNews(scope);
        }
    }

    function generateMockNews(level) {
        let name = 'Local';
        if (level === 'city' && currentLocationData) name = currentLocationData.city;
        else if (level === 'state' && currentLocationData) name = currentLocationData.state;
        else if (level === 'country' && currentLocationData) name = currentLocationData.country_name;
        else if (level === 'international') name = 'World';
        
        return [
            { id: `${level}-1`, title: `${name} News: Major development in infrastructure`, link: `https://example.com/1`, snippet: "A significant project announced today promises to improve transportation and create thousands of jobs for the region.", source: "Local News Network", date: new Date().toISOString(), thumbnail: "https://placehold.co/600x400/3b82f6/ffffff?text=News+1" },
            { id: `${level}-2`, title: `Breaking: Important ${name} announcement`, link: `https://example.com/2`, snippet: "Officials released new guidelines that will impact residents starting next month. Here's what you need to know.", source: "News Today", date: new Date(Date.now() - 3600000).toISOString() },
            { id: `${level}-3`, title: `${name} economy shows positive growth`, link: `https://example.com/3`, snippet: "Recent economic data indicates a strong recovery, with experts predicting continued growth through the next quarter.", source: "Economic Times", date: new Date(Date.now() - 86400000).toISOString(), thumbnail: "https://placehold.co/600x400/10b981/ffffff?text=Economy" }
        ];
    }

    // --- UI RENDERING & UPDATES ---
    function displayNews(articles) {
        if (!articles || articles.length === 0) {
            newsContent.innerHTML = `<div class="text-center py-12"><div class="text-gray-400 text-6xl mb-4">ðŸ“°</div><h3 class="text-lg font-medium text-gray-900 mb-2">No news found</h3><p class="text-gray-600">Please try a different tab or check back later.</p></div>`;
            return;
        }
        newsContent.innerHTML = `<div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">${articles.map(article => createArticleHTML(article, selectedArticles.has(article.id))).join('')}</div>`;
    }

    function createArticleHTML(article, isSelected) {
        return `<article class="news-card bg-white rounded-lg shadow-md overflow-hidden relative cursor-pointer ${isSelected ? 'selected' : ''}" tabindex="0" onclick="handleArticleClick('${article.id.replace(/'/g, "\\'")}', this)">
            <div class="checkbox-container"><span class="material-symbols-outlined">${isSelected ? 'check_circle' : 'radio_button_unchecked'}</span></div>
            ${article.thumbnail 
                ? `<img src="${article.thumbnail}" alt="" class="w-full h-48 object-cover pointer-events-none">` 
                : `<div class="w-full h-48 bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center pointer-events-none"><svg class="w-12 h-12 text-white opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path></svg></div>`
            }
            <div class="p-6 pointer-events-none">
                <h3 class="font-bold text-lg text-gray-900 mb-2 line-clamp-2"><a href="${article.link}" target="_blank" class="hover:text-blue-600 pointer-events-auto" onclick="event.stopPropagation()">${article.title}</a></h3>
                <p class="text-gray-600 text-sm mb-4 line-clamp-3">${article.snippet || ''}</p>
                <div class="flex justify-between items-center text-sm text-gray-500">
                    <span class="font-medium truncate pr-4">${article.source || 'Unknown'}</span>
                    <span class="flex-shrink-0">${formatDate(article.date)}</span>
                </div>
            </div>
        </article>`;
    }

    function renderWorkspaceArticles() {
        const container = document.getElementById('generateContent');
        if (workspaceArticles.size === 0) {
            container.innerHTML = `<div class="text-center py-12"><div class="text-gray-400 text-6xl mb-4">âœ¨</div><h3 class="text-lg font-medium">Workspace is empty</h3><p class="text-gray-600">Select articles from the Discover tab to get started.</p></div>`;
            return;
        }
        container.innerHTML = `<div class="space-y-4">${Array.from(workspaceArticles.values()).map(article => {
            const statusBg = article.status === 'Generated' ? 'bg-green-100 text-green-800' : (article.status === 'Generating' ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800');
            return `<div class="bg-white p-4 rounded-lg shadow-sm flex items-center justify-between cursor-pointer hover:bg-gray-50" onclick="openSlideOver('${article.id}')">
                <div>
                    <p class="font-semibold text-gray-800 line-clamp-1">${article.title}</p>
                    <p class="text-sm text-gray-500">${article.source} &middot; ${formatDate(article.date)}</p>
                </div>
                <span class="text-xs font-bold px-2 py-1 rounded-full ${statusBg}">${article.status || 'Selected'}</span>
            </div>`;
        }).join('')}</div>`;
    }

    function renderMyArticles() {
        const container = document.getElementById('myArticlesContent');
        const saved = Array.from(workspaceArticles.values()).filter(a => a.status === 'Saved');
         if (saved.length === 0) {
            container.innerHTML = `<div class="text-center py-12"><div class="text-gray-400 text-6xl">ðŸ“‚</div><h3>No saved articles</h3><p class="text-gray-600">Generate and save articles to see them here.</p></div>`;
            return;
        }
        container.innerHTML = `<div class="space-y-4">${saved.map(a => `<div class="bg-white p-4 rounded-lg shadow-sm">...</div>`).join('')}</div>`;
    }

    function updateSelectionBar() {
        const count = selectedArticles.size;
        selectionCount.textContent = count > 0 ? `${count} article${count > 1 ? 's' : ''} selected` : '';
        selectionBar.classList.toggle('translate-y-full', count === 0);
    }

    // --- EVENT HANDLERS & ACTIONS ---
    function handleArticleClick(articleId, cardElement) {
        const icon = cardElement.querySelector('.checkbox-container .material-symbols-outlined');
        if (selectedArticles.has(articleId)) {
            selectedArticles.delete(articleId);
            cardElement.classList.remove('selected');
            if (icon) icon.textContent = 'radio_button_unchecked';
        } else {
            const article = newsData[currentTab]?.find(a => a.id === articleId);
            if(article) {
                selectedArticles.set(articleId, article);
                cardElement.classList.add('selected');
                if (icon) icon.textContent = 'check_circle';
            }
        }
        updateSelectionBar();
    }

    function handleOpenGenerateTab() {
        const selectionSize = selectedArticles.size;
        if (selectionSize === 0) return;
        selectedArticles.forEach((article, id) => {
            if (!workspaceArticles.has(id)) {
                workspaceArticles.set(id, { ...article, status: 'Selected' });
            }
        });
        const prevSelectedSize = selectedArticles.size;
        selectedArticles.clear();
        updateSelectionBar();
        displayNews(newsData[currentTab]);
        navigateToView('generate');
        showToast({ title: 'Success', message: `${prevSelectedSize} article${prevSelectedSize > 1 ? 's' : ''} added to Generate`});
    }

    function openSlideOver(articleId) {
        const article = workspaceArticles.get(articleId);
        if (!article) return;
        
        const isGenerated = article.status === 'Generated' || article.status === 'Saved';
        const isGenerating = article.status === 'Generating';

        let generatedSnippetHTML = '';
        if (isGenerated && article.generatedContent) {
            const snippet = article.generatedContent.snippet;
            const needsTruncation = snippet.length > 250;
            if (needsTruncation) {
                generatedSnippetHTML = `
                    <div class="text-sm text-gray-800">
                        <div id="truncatedSnippet">${snippet.substring(0, 250)}...</div>
                        <div id="fullSnippet" class="hidden">${snippet}</div>
                        <button onclick="toggleSnippet(this)" class="text-blue-600 hover:underline text-sm font-semibold mt-1">Read more</button>
                    </div>`;
            } else {
                generatedSnippetHTML = `<div class="text-sm text-gray-800">${snippet}</div>`;
            }
        }

        let optionsHTML = '';
        const options = article.generationOptions;
        if (options) {
             optionsHTML = `
                <div class="border-t border-b border-gray-200 py-4 space-y-2">
                    <h4 class="text-sm font-semibold text-gray-800">Your selected options:</h4>
                    <div class="flex justify-between text-sm text-gray-600"><span>Language:</span><span class="font-medium">${options.language}</span></div>
                    <div class="flex justify-between text-sm text-gray-600"><span>Tone:</span><span class="font-medium">${options.tone}</span></div>
                    <div class="flex justify-between text-sm text-gray-600"><span>Style:</span><span class="font-medium">${options.style}</span></div>
                    <div class="flex justify-between text-sm text-gray-600"><span>Length:</span><span class="font-medium">${options.length.toUpperCase() || 'N/A'}</span></div>
                </div>`;
        }


        slideOverPanel.innerHTML = `<div class="h-full flex flex-col bg-white shadow-xl">
            <header class="p-6 bg-gray-50 border-b flex items-start justify-between">
                <h2 class="text-lg font-medium text-gray-900">${isGenerated ? 'Generated Article' : 'Article Details'}</h2>
                <div>
                  ${isGenerated ? `<button class="text-sm text-blue-600 hover:underline" onclick="showOriginalArticleInSlideOver('${articleId}')">View Original</button>` : ''}
                  <button type="button" class="ml-3 text-gray-400 hover:text-gray-500" onclick="closeSlideOver()"><span class="material-symbols-outlined">close</span></button>
                </div>
            </header>
            <div class="flex-1 overflow-y-auto p-6 space-y-6">
                 ${isGenerated ? '' : `
                    <div>
                        <h3 class="font-semibold text-gray-800">${article.title}</h3>
                        <p class="text-sm text-gray-600 mt-1">${article.snippet}</p>
                        <a href="${article.link}" target="_blank" rel="noopener noreferrer" class="text-sm text-blue-600 hover:underline mt-2 inline-flex items-center space-x-1">
                            <span>Read full article</span>
                            <span class="material-symbols-outlined" style="font-size: 16px;">open_in_new</span>
                        </a>
                    </div>
                 `}
                
                ${(isGenerating || isGenerated) && optionsHTML ? optionsHTML : ''}

                ${isGenerating ? `<div class="bg-blue-50 p-4 rounded-lg text-center"><p class="text-sm text-blue-700 font-medium">Your article is being generated. You will be notified once it is ready.</p></div>` : ''}

                ${!isGenerated && !isGenerating ? `
                <div><label for="language" class="block text-sm font-medium text-gray-700">Language</label><select id="language" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"><option>English</option><option>Hindi</option><option>Marathi</option></select></div>
                <div><label for="tone" class="block text-sm font-medium text-gray-700">Tone</label><select id="tone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"><option>Neutral</option><option>Formal</option><option>Casual</option></select></div>
                <div><label for="style" class="block text-sm font-medium text-gray-700">Style</label><select id="style" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"><option>Informative</option><option>Narrative</option></select></div>
                <div><label for="length" class="block text-sm font-medium text-gray-700">Length</label><select id="length" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"><option value="short">Short</option><option value="medium" selected>Medium</option><option value="long">Long</option></select></div>`
                : ''}

                ${isGenerated ? `<div class="bg-gray-50 p-4 rounded-lg space-y-2">
                        <h4 class="font-semibold text-gray-900">${article.generatedContent.title}</h4>
                        <div class="generated-snippet">${generatedSnippetHTML}</div>
                   </div>` : ''}
            </div>
            <footer class="p-6 bg-gray-50 border-t flex ${isGenerated ? 'justify-end' : 'justify-end'} items-center">
                ${isGenerated ? `<button class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2" onclick="saveArticle('${article.id}')"><span class="material-symbols-outlined">save</span><span>Save</span></button>` 
                : ''}
                ${!isGenerated && !isGenerating ? `<button class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2" onclick="handleGenerateArticle('${article.id}')"><span class="material-symbols-outlined">auto_awesome</span><span>Generate Article</span></button>` : ''}
            </footer>
        </div>`;
        
        slideOverContainer.classList.remove('invisible');
        slideOverPanel.classList.remove('translate-x-full');
    }
    
    function showOriginalArticleInSlideOver(articleId) {
        const article = workspaceArticles.get(articleId);
        if (!article) return;
        slideOverPanel.innerHTML = `<div class="h-full flex flex-col bg-white shadow-xl">
            <header class="p-6 bg-gray-50 border-b flex items-start justify-between">
                <h2 class="text-lg font-medium text-gray-900">Original Article</h2>
                 <button type="button" class="ml-3 text-gray-400 hover:text-gray-500" onclick="openSlideOver('${articleId}')"><span class="material-symbols-outlined">arrow_back</span></button>
            </header>
            <div class="flex-1 overflow-y-auto p-6 space-y-4">
                 <div>
                    <h3 class="font-semibold text-gray-800">${article.title}</h3>
                    <p class="text-sm text-gray-600 mt-1">${article.snippet}</p>
                    <a href="${article.link}" target="_blank" rel="noopener noreferrer" class="text-sm text-blue-600 hover:underline mt-2 inline-flex items-center space-x-1">
                        <span>Read full article</span>
                        <span class="material-symbols-outlined" style="font-size: 16px;">open_in_new</span>
                    </a>
                </div>
            </div>
        </div>`;
    }

    function closeSlideOver() {
        slideOverPanel.classList.add('translate-x-full');
        slideOverContainer.classList.add('invisible');
    }

    async function handleGenerateArticle(articleId) {
        const article = workspaceArticles.get(articleId);
        if (!article) return;

        const button = event.target.closest('button');
        const originalHTML = button.innerHTML;
        button.disabled = true;
        button.innerHTML = `<div class="spinner btn-spinner"></div>`;

        const language = document.getElementById('language')?.value || 'English';
        const tone = document.getElementById('tone')?.value.toLowerCase() || 'neutral';
        const style = document.getElementById('style')?.value.toLowerCase() || 'informative';
        const lengthInput = document.getElementById('length');
        // let length = 250;
        // if (lengthInput) {
        //     length = parseInt(lengthInput.value, 10);
        //     if (isNaN(length) || length < 100) length = 100;
        //     if (length > 400) length = 400;
        // }
        const length = lengthInput.value.toLowerCase() || 'medium'
        article.generationOptions = { language, tone: tone.charAt(0).toUpperCase() + tone.slice(1), style: style.charAt(0).toUpperCase() + style.slice(1), length: length };
        article.status = 'Generating';
        workspaceArticles.set(article.id, article);
        
        renderWorkspaceArticles();
        closeSlideOver();

        const requestBody = { tone, style, word_length: length, language };

        try {
            const response = await fetch(`${API_BASE_URL}/generate/${article.id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) throw new Error(`API call failed with status ${response.status}`);

            const generatedData = await response.json();
            article.status = 'Generated';
            article.generatedContent = generatedData;
            workspaceArticles.set(article.id, article);
            showToast({
                title: 'Generated',
                message: article.title,
                button: { text: 'View', onClick: () => openSlideOver(article.id) }
            });

        } catch (error) {
            console.error("API call failed, generating mock content instead.", error);
            article.status = 'Generated';
            article.generatedContent = {
                title: `AI: ${article.title}`,
                snippet: `<p>This is a newly generated version of the article titled "<b>${article.title}</b>".</p><p>It has been crafted in <b>${language}</b> with a ${tone} tone, ${style} style, and for a length of approximately ${length} words.</p><br/><p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed non risus. Suspendisse lectus tortor, dignissim sit amet, adipiscing nec, ultricies sed, dolor. Cras elementum ultrices diam. Maecenas ligula massa, varius a, semper congue, euismod non, mi. Proin porttitor, orci nec nonummy molestie, enim est eleifend mi, non fermentum diam nisl sit amet erat.</p>`
            };
            workspaceArticles.set(article.id, article);
            showToast({
                title: 'Generated (Fallback)',
                message: article.title,
                button: { text: 'View', onClick: () => openSlideOver(article.id) }
            });
        } finally {
            renderWorkspaceArticles();
        }
    }

    function toggleSnippet(button) {
        const snippetContainer = button.parentElement;
        const truncated = snippetContainer.querySelector('#truncatedSnippet');
        const full = snippetContainer.querySelector('#fullSnippet');

        if (truncated.classList.contains('hidden')) {
            truncated.classList.remove('hidden');
            full.classList.add('hidden');
            button.textContent = 'Read more';
        } else {
            truncated.classList.add('hidden');
            full.classList.remove('hidden');
            button.textContent = 'Read less';
        }
    }

    async function handleGenerateAll() {
        // ... (implementation for batch generation)
    }

    function saveArticle(articleId) {
        const article = workspaceArticles.get(articleId);
        if (!article) return;
        article.status = 'Saved';
        renderWorkspaceArticles();
        closeSlideOver();
        showToast({ title: 'Success', message: 'Article saved!' });
    }

    // --- NAVIGATION & HELPERS ---
    function navigateToView(viewName) {
        mainViews.forEach(view => view.classList.toggle('hidden', view.id !== `${viewName}View`));
        sidebarLinks.forEach(l => {
            const isActive = l.dataset.view === viewName;
            l.classList.toggle('bg-gray-100', isActive);
            l.classList.toggle('font-semibold', isActive);
        });
        if (viewName === 'generate') renderWorkspaceArticles();
        if (viewName === 'articles') renderMyArticles();
    }

    function showToast({ title, message, button }) {
        const toast = document.getElementById('toast');
        let buttonHTML = '';
        if (button) {
            const buttonId = `toast-btn-${Date.now()}`;
            buttonHTML = `<button id="${buttonId}" class="bg-white/20 hover:bg-white/30 text-white text-sm font-bold py-1 px-3 rounded-md">${button.text}</button>`;
            
            toast.onclick = (e) => {
                if (e.target.id === buttonId) {
                    button.onClick();
                    toast.classList.add('translate-x-[150%]', 'opacity-0');
                }
            };
        } else {
            toast.onclick = null;
        }

        toast.innerHTML = `
            <div>
                <p class="font-bold">${title}</p>
                <p class="text-sm line-clamp-1">${message}</p>
            </div>
            ${buttonHTML}
        `;
        toast.classList.remove('translate-x-[150%]', 'opacity-0');
        setTimeout(() => {
            toast.classList.add('translate-x-[150%]', 'opacity-0');
        }, 5000);
    }

    function updateTabLabels(data) {
        document.getElementById('cityTabLabel').textContent = data.city;
        document.getElementById('stateTabLabel').textContent = data.state;
        document.getElementById('countryTabLabel').textContent = data.country_name;
    }

    function updateActiveTab(tab) {
        tabButtons.forEach(btn => {
            btn.classList.toggle('tab-active', btn.dataset.tab === tab);
            btn.setAttribute('aria-selected', btn.dataset.tab === tab);
        });
        newsContent.setAttribute('aria-labelledby', `tab-${tab}`);
        currentTab = tab;
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diff = Math.floor((now - date) / 1000);
        if (diff < 60) return 'Just now';
        if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
        if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
        return `${Math.floor(diff / 86400)}d ago`;
    }

    // --- EVENT LISTENERS ---
    locationSearch.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim();
        if (query.length < 3) {
            locationDropdown.classList.add('hidden');
            return;
        }
        searchTimeout = setTimeout(() => searchLocations(query), 300);
    });

    locationSearch.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowDown' && !locationDropdown.classList.contains('hidden')) {
            e.preventDefault();
            const firstItem = locationDropdown.querySelector('div[tabindex]');
            if (firstItem) firstItem.focus();
        }
    });

    useGeolocationBtn.addEventListener('click', () => {
        locationError.classList.add('hidden');
        locationLoading.classList.remove('hidden');
        useGeolocationBtn.disabled = true;

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    try {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        selectLocation({ city: 'Nagpur', state: 'Maharashtra', country: 'IN', country_name: 'India' });
                    } catch (error) {
                         showLocationError('Failed to determine your location.');
                    } finally {
                        locationLoading.classList.add('hidden');
                        useGeolocationBtn.disabled = false;
                    }
                },
                (error) => {
                    locationLoading.classList.add('hidden');
                    useGeolocationBtn.disabled = false;
                    let msg = 'Unable to access your location. ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED: msg += 'Please allow location access.'; break;
                        case error.POSITION_UNAVAILABLE: msg += 'Location information is unavailable.'; break;
                        case error.TIMEOUT: msg += 'Location request timed out.'; break;
                        default: msg += 'An unknown error occurred.';
                    }
                    showLocationError(msg);
                }, { timeout: 10000 }
            );
        } else {
            locationLoading.classList.add('hidden');
            useGeolocationBtn.disabled = false;
            showLocationError('Geolocation is not supported by your browser.');
        }
    });
    
    document.addEventListener('click', (e) => {
        if (!locationSearch.contains(e.target) && !locationDropdown.contains(e.target)) {
            locationDropdown.classList.add('hidden');
        }
    });

    openGenerateTabButton.addEventListener('click', handleOpenGenerateTab);
    generateAllButton.addEventListener('click', handleGenerateAll);
    sidebarLinks.forEach(link => link.addEventListener('click', (e) => {
        e.preventDefault();
        navigateToView(link.dataset.view);
    }));
    slideOverBackdrop.addEventListener('click', closeSlideOver);
    changeLocationBtn.addEventListener('click', () => {
        appContainer.classList.add('hidden');
        locationSelection.classList.remove('hidden');
        localStorage.removeItem('newsHubLocation');
    });
    retryLoadingBtn.addEventListener('click', () => loadNewsForTab(currentTab));
    tabButtons.forEach(button => {
        button.addEventListener('click', async () => {
            const tab = button.dataset.tab;
            updateActiveTab(tab);
            if (!newsData[tab]) await loadNewsForTab(tab);
            else displayNews(newsData[tab]);
        });
    });
    
    initApp();
</script>
    </body>
</html>